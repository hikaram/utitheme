(function($){
    $.Tree={version:'1.0'};
    $.fn.Tree=function(settings){
        settings=jQuery.extend({
            ajax:false,
            initial_expanding:1,
            shifting:25,
            css_display:'table-row',
            subtree:false,
            subtree_nodes:'root',
            subtree_markup:'<div class="tnm-subtree"><div class="tnmst-menu"><span class="tnmst-menu-element tnm-toggle mode-subtree" action="expand" mode="subtree">Развернуть полностью</span><hr style="background-color:#a3a2a2;" size="1px"><span class="tnmst-menu-element tnm-toggle mode-subtree" action="collapse" mode="subtree">Свернуть полностью</span></div></div>'
    },settings);
    var mode='firstline';
    var action='collapse';
    send_ajax=function(options){
        if(options.node_attributes!=undefined){
            $.each(options.node_attributes,function(index,v){
                var value=$.Tree.node.attr(v);
                if(value!=undefined){
                    if(options.data==undefined)options.data={};
                    options.data[index]=value;
                }
            });
        }
        options=jQuery.extend({
            url:false,
            data:{},
            _onError:function(){
                $.Tree.toggle_loading();
                alert('Error request');
            },
            _onComplete:function(){return true;},
            _beforeSend:function(){return true;},
            cache:false,
            type:'POST',
            async:true,
            dataType:'json'
        },options);
        if(!options.url)return false;
        $.Tree.toggle_loading();
        $.ajax({
            url:options.url,
            type:options.type,
            dataType:options.dataType,
            error:options._onError,
            beforeSend:options._beforeSend,
            complete:options._onComplete,
            success:function(data){
                $.Tree.toggle_loading();
                if(data.error){alert(data.error);}
                if(data.content){
                    $.Tree.node.after(data.content);
                    $.Tree.get_first_line().each(function(){
                        var node=$(this);
                        node.children('.tn-manager').css('padding-left',settings.shifting*parseInt(node.attr('level')));
                    });
                    $.Tree.toggle_node_state();
                    var first_line=$.Tree.get_first_line();
                    first_line.each(function(){
                        var node=$(this);
                        var children_count=node.attr('children_count');
                        if(children_count>0)node.addClass('collapsed');
                        var tnm_children=node.find('.tnm-children');
                        tnm_children.addClass('tnm-toggle').attr('mode','firstline').attr('action','expand');
                        if(settings.subtree==true&&settings.subtree_nodes=='all'){
                            node.children('.tn-manager').prepend(settings.subtree_markup);
                            tnm_children.css('margin-top','-20px');
                        }
                    });
                    $.Tree.branch_manager('expand','firstline');
                }
            },
            data:options.data,
            async:options.async,
            cache:options.cache
        });
        return false;
    };
    $.Tree.branch_manager=function(_action,mode){
        var _this=this;
        var children=this.get_first_line();
        var display=(_action=='expand')?settings.css_display:'none';
        children.each(function(){
            var node=$(this);
            node.css('display',display);
            switch(mode){
                case'firstline':
                    if(node.hasClass('expanded')){
                        _this.node=node;
                        _this.branch_manager(_action,mode);
                    }
                    break;
                case'subtree':
                    _this.node=node;
                    if(_this.get_first_line().length<=0)break;
                    if(_action=='expand'&&node.hasClass('collapsed'))_this.toggle_node_state();
                    if(_action=='collapse'&&node.hasClass('expanded'))_this.toggle_node_state();
                    _this.branch_manager(_action,mode);
                    break;
                default:return false;
            }
        return true;
        });
    };
    $.Tree.get_first_line=function(){
        return this.node.siblings('.tn-container[parent='+this.get_node_id()+']');
    };
    $.Tree.get_node_id=function(){
        return this.node.attr('node');
    };
    $.Tree.toggle_loading=function(){
        this.node.find('.tnm-children').toggleClass('loading');
    };
    $.Tree.toggle=function(node){
        this.set_node(node);
        var first_line=this.get_first_line();
        if(first_line.length==0)return false;
        if(mode=='firstline'){
            this.node.hasClass('expanded')?this.branch_manager('collapse',mode):this.branch_manager('expand',mode);
            this.set_node(node);
            this.toggle_node_state();
        }else{
            this.branch_manager(action,mode);
            if(action=='expand'&&node.hasClass('collapsed')){
                this.set_node(node);
                this.toggle_node_state();
            }
            if(action=='collapse'&&node.hasClass('expanded')){
                this.set_node(node);
                this.toggle_node_state();
            }
        }
        return true;
    };
    $.Tree.toggle_node_state=function(){
        this.node.toggleClass('expanded').toggleClass('collapsed');
    };
    $.Tree.toggle_node_action=function(){
        var toggle_element=this.node.find('tnm-children');
        var attr=toggle_element.attr('action');
        attr=='expand'?toggle_element.attr('action','collapse'):toggle_element.attr('action','expand');
    };
    $.Tree.set_node=function(node){this.node=node;};
    handler=function(event){
        var target_element=$(event.target);
        var node=target_element.parents('.tn-container:first');
        var tnm_children=node.find('.tnm-children');
        if(tnm_children.hasClass('loading'))return false;
        mode=target_element.attr('mode');
        action=target_element.attr('action');
        if($.Tree.toggle(node))return false;
        if(!settings.ajax||typeof(settings.ajax)!='object')return false;
        send_ajax(settings.ajax);
        return false;
    };
    this.each(function(){
        var tree=$(this).find('.tn-container');
        tree.each(function(node_index,node_obj){
            var node=$(this);
            var level=parseInt(node.attr('level'));
            if(node.attr('children_count')>0){
                var class_node_state=(level<settings.initial_expanding)?'expanded':'collapsed';
                var attribute_action=(level<settings.initial_expanding)?'collapse':'expand';
                node.addClass(class_node_state);
                var tnm_children=node.find('div.tnm-children');
                tnm_children.addClass('tnm-toggle').attr('mode','firstline').attr('action',attribute_action);
                if(settings.subtree==true&&(settings.subtree_nodes=='root'&&node_index==0)||settings.subtree_nodes=='all'){
                    node.children('.tn-manager').prepend(settings.subtree_markup);
                    tnm_children.css('margin-top','-20px');
                }
            }
            node.children('.tn-manager').css('padding-left',settings.shifting*level);
            if(level<settings.initial_expanding+1){node.css('display',settings.css_display);}
        });
        tree.find('.tnm-toggle').live('click',handler);
        return false;
    });
    return this;
    };
})(jQuery);